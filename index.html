<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boutique en ligne</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      background-color: #F1E1C6;
      transition: background 0.3s;
    }

    .dark-mode {
      background-color: #A56D47;
      color: white;
    }

    .navbar {
      background-color: #A56D47 !important;
    }

    .btn-primary {
      background-color: #A56D47;
      border-color: #7f5c48;
    }

    .btn-primary:hover {
      background-color: #A56D47;
      border-color: #6b4f34;
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.3s;
      cursor: pointer;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 12px 24px rgba(127, 92, 72, 0.3);
    }

    .card-img-top {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 10px 10px 0 0;
    }

    .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      min-height: 3rem;
    }

    .floating-cart {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #7f5c48;
      color: white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.3s;
    }

    .floating-cart:hover {
      background-color: #6b4f34;
      transform: scale(1.1);
    }

    .detail-view {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-width: 80%;
      max-height: 90vh;
      overflow-y: auto;
      width: 600px;
    }

    .detail-view.active {
      display: flex;
      flex-direction: row;
      gap: 30px;
    }

    .detail-img-container {
      flex: 1;
      min-width: 250px;
    }

    .detail-info {
      flex: 1;
    }

    .detail-img {
      width: 100%;
      max-height: 350px;
      object-fit: contain;
      border-radius: 10px;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .overlay.active {
      display: block;
    }

    .stock-badge {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }

    .auction-price {
      font-weight: bold;
      color: #d63384;
    }

    .close-detail {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1001;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="/">üõç Boutique</a>
      <button class="btn btn-outline-light me-2" onclick="toggleDarkMode()">üåô Mode sombre</button>

      {% if session.get('customer_email') %}
        <a href="{{ url_for('profile') }}" class="btn btn-outline-light me-2">üë§ Mon Profil</a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light me-2">üö™ D√©connexion</a>
      {% else %}
        <a href="{{ url_for('login', redirect='profile') }}" class="btn btn-outline-light me-2">üë§ Connexion</a>
      {% endif %}

      <a href="{{ url_for('cart') }}" class="btn btn-outline-light position-relative">
        üõí Panier
        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          {{ cart_count }}
        </span>
      </a>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="d-flex justify-content-end flex-wrap gap-3 mb-3">
      <select class="form-select form-select-sm" id="brandFilter" style="max-width: 180px;">
        <option value="">-- Filtrer par marque --</option>
      </select>

      <select class="form-select form-select-sm" id="priceOrder" style="max-width: 180px;">
        <option value="">-- Trier par prix --</option>
        <option value="asc">Prix croissant</option>
        <option value="desc">Prix d√©croissant</option>
      </select>
    </div>

    <div class="row" id="productList">
      <!-- Produits inject√©s dynamiquement -->
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="detail-view" id="detailView">
      <span class="close-detail" onclick="closeDetail()">&times;</span>
      <div class="detail-img-container">
        <img id="detailImg" class="detail-img" src="" alt="">
      </div>
      <div class="detail-info">
        <h3 id="detailName"></h3>
        <p><strong>Marque:</strong> <span id="detailBrand"></span></p>
        <p><strong>Style:</strong> <span id="detailStyle"></span></p>
        <p><strong>Peau:</strong> <span id="detailSkin"></span></p>
        <p><strong>Int√©rieur:</strong> <span id="detailInner"></span></p>
        <p><strong>Couleur:</strong> <span id="detailColor"></span></p>
        <p><strong>Volume:</strong> <span id="detailVolume"></span></p>
        <p><strong>Accessoires:</strong> <span id="detailAccessories"></span></p>
        <p><strong>Prix:</strong> <span id="detailPrice"></span></p>
        <p><strong>Disponibilit√©:</strong> <span id="detailStock"></span></p>
        <p><strong>Type:</strong> <span id="detailType"></span></p>
        <button id="detailActionBtn" class="btn btn-primary mt-3 w-100"></button>
      </div>
    </div>

    {% if products %}
      <div class="row mt-4">
        {% for product in products %}
        <div class="col-md-4 mb-4">
          <div class="card h-100" onclick="showDetail({
            'id': {{ product.id }},
            'name': '{{ product.name | replace("'", "\\'") }}',
            'price': {{ product.price }},
            'image': '{{ url_for('static', filename='images/' + product.image) }}',
            'brand': '{{ product.brand | replace("'", "\\'") }}',
            'is_auction': {% if product.is_auction %}true{% else %}false{% endif %},
            'bag_style': '{{ product.bag_style | replace("'", "\\'") }}',
            'skin_type': '{{ product.skin_type | replace("'", "\\'") }}',
            'inner_material': '{{ product.inner_material | replace("'", "\\'") }}',
            'major_color': '{{ product.major_color | replace("'", "\\'") }}',
            'volume': {% if product.volume %}{{ product.volume }}{% else %}null{% endif %},
            'accessories': '{{ product.accessories | replace("'", "\\'") }}',
            'stock': {{ product.stock }}
          })">
            <img src="{{ url_for('static', filename='images/' + product.image) }}" class="card-img-top" alt="{{ product.name }}">
            <div class="card-body text-center">
              <h5 class="card-title">{{ product.name }}</h5>
              <div class="mt-auto">
                {% if product.is_auction %}
                  <span class="badge bg-warning mb-2">Ench√®re</span>
                  <p class="auction-price">Prix de d√©part: {{ product.price }} ‚Ç¨</p>
                {% else %}
                  <p class="card-text fw-bold">{{ product.price }} ‚Ç¨</p>
                  {% if product.stock > 0 %}
                    <span class="badge bg-success stock-badge">En stock</span>
                  {% else %}
                    <span class="badge bg-danger stock-badge">Rupture de stock</span>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center">Aucun produit disponible.</p>
    {% endif %}
  </div>

  <!-- Popup Ench√®re -->
  <div class="modal fade" id="auctionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ench√©rir</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Voulez-vous avoir une id√©e du prix avant d'ench√©rir ?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-info" onclick="predictPrice()">Oui, Pr√©dire le prix</button>
          <button class="btn btn-success" onclick="directBid()">Non, Ench√©rir directement</button>
        </div>
      </div>
    </div>
  </div>

  <a href="/cart" class="floating-cart">üõí</a>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const productList = document.getElementById("productList");
    const detailView = document.getElementById("detailView");
    const overlay = document.getElementById("overlay");
    const brandFilter = document.getElementById("brandFilter");
    const priceOrder = document.getElementById("priceOrder");
    let allProducts = [];
    let selectedProduct = null;
    let isDetailOpen = false;

    // Chargement initial
    document.addEventListener('DOMContentLoaded', function() {
      loadProductsFromTemplate();
      setupEventListeners();
    });

    function loadProductsFromTemplate() {
      const productElements = document.querySelectorAll('.card[onclick^="showDetail"]');
      allProducts = Array.from(productElements).map(card => {
        const onclickContent = card.getAttribute('onclick');
        const jsonStr = onclickContent.replace('showDetail(', '').replace(')', '');
        return JSON.parse(jsonStr);
      });
      populateBrandFilter();
    }

    function populateBrandFilter() {
      const brands = [...new Set(allProducts.map(p => p.brand).filter(b => b))];
      brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        brandFilter.appendChild(option);
      });
    }

    function setupEventListeners() {
      brandFilter.addEventListener('change', applyFilters);
      priceOrder.addEventListener('change', applyFilters);
      overlay.addEventListener('click', closeDetail);
    }

    function applyFilters() {
      const selectedBrand = brandFilter.value;
      const order = priceOrder.value;
      let filtered = [...allProducts];

      // Filtrage par marque (case insensitive)
      if (selectedBrand) {
        filtered = filtered.filter(p => p.brand && p.brand.toLowerCase() === selectedBrand.toLowerCase());
      }

      // Tri par prix
      if (order === 'asc') {
        filtered.sort((a, b) => a.price - b.price);
      } else if (order === 'desc') {
        filtered.sort((a, b) => b.price - a.price);
      }

      renderProducts(filtered);
    }

    function renderProducts(products) {
      productList.innerHTML = "";
      products.forEach(product => {
        const col = document.createElement("div");
        col.className = "col-md-4 mb-4";

        const stockBadge = product.is_auction ? '' :
          product.stock > 0 ?
            `<span class="badge bg-success stock-badge">En stock</span>` :
            `<span class="badge bg-danger stock-badge">Rupture de stock</span>`;

        const priceDisplay = product.is_auction ?
          `<span class="badge bg-warning mb-2">Ench√®re</span>
           <p class="auction-price">Prix de d√©part: ${product.price} ‚Ç¨</p>` :
          `<p class="card-text fw-bold">${product.price} ‚Ç¨</p> ${stockBadge}`;

        const card = `
          <div class="card h-100" onclick="showDetail(${JSON.stringify(product)})">
            <img src="${product.image}" class="card-img-top" alt="${product.name}">
            <div class="card-body text-center">
              <h5 class="card-title">${product.name}</h5>
              <div class="mt-auto">${priceDisplay}</div>
            </div>
          </div>`;

        col.innerHTML = card;
        productList.appendChild(col);
      });
    }

    function showDetail(product) {
      if (isDetailOpen && selectedProduct && selectedProduct.id === product.id) {
        closeDetail();
        return;
      }

      selectedProduct = product;
      isDetailOpen = true;

      // Mise √† jour des d√©tails
      document.getElementById("detailImg").src = product.image;
      document.getElementById("detailName").textContent = product.name;
      document.getElementById("detailBrand").textContent = product.brand || 'Non sp√©cifi√©';
      document.getElementById("detailStyle").textContent = product.bag_style || 'Non sp√©cifi√©';
      document.getElementById("detailSkin").textContent = product.skin_type || 'Non sp√©cifi√©';
      document.getElementById("detailInner").textContent = product.inner_material || 'Non sp√©cifi√©';
      document.getElementById("detailColor").textContent = product.major_color || 'Non sp√©cifi√©';
      document.getElementById("detailVolume").textContent = product.volume || 'Non sp√©cifi√©';
      document.getElementById("detailAccessories").textContent = product.accessories || 'Aucun';

      // Affichage du prix et disponibilit√©
      const detailPrice = document.getElementById("detailPrice");
      const detailStock = document.getElementById("detailStock");
      const detailType = document.getElementById("detailType");
      const detailActionBtn = document.getElementById("detailActionBtn");

      if (product.is_auction) {
        detailPrice.innerHTML = `<span class="auction-price">Prix de d√©part: ${product.price} ‚Ç¨</span>`;
        detailStock.textContent = "Disponible pour ench√®re";
        detailType.innerHTML = '<span class="badge bg-warning">Ench√®re</span>';
        detailActionBtn.textContent = 'Ench√©rir';
        detailActionBtn.onclick = showPopup;
        detailActionBtn.disabled = false;
      } else {
        detailPrice.textContent = `${product.price} ‚Ç¨`;
        detailStock.textContent = product.stock > 0 ? "En stock" : "Rupture de stock";
        detailType.innerHTML = '<span class="badge bg-success">Achat direct</span>';
        detailActionBtn.textContent = product.stock > 0 ? 'Ajouter au panier' : 'Rupture de stock';
        detailActionBtn.disabled = product.stock <= 0;
        detailActionBtn.onclick = function() {
          if (product.stock > 0) addToCart(product.id);
        };
      }

      detailView.classList.add('active');
      overlay.classList.add('active');
    }

    function closeDetail() {
      isDetailOpen = false;
      detailView.classList.remove('active');
      overlay.classList.remove('active');
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    function showPopup() {
      const modal = new bootstrap.Modal(document.getElementById('auctionModal'));
      modal.show();
    }

    function addToCart(productId) {
      fetch(`/add_to_cart/${productId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          closeDetail();
          loadProductsFromTemplate();
          applyFilters();
        } else {
          document.querySelectorAll('#cart-count').forEach(el => {
            el.textContent = data.cart_count;
          });
          closeDetail();
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    function predictPrice() {
      if (!selectedProduct) return;

      fetch('/predict', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          brand: selectedProduct.brand,
          bag_style: selectedProduct.bag_style,
          skin_type: selectedProduct.skin_type,
          inner_material: selectedProduct.inner_material,
          major_color: selectedProduct.major_color,
          volume: selectedProduct.volume,
          accessories: selectedProduct.accessories
        })
      })
      .then(response => {
        if (!response.ok) throw new Error('Erreur de pr√©diction');
        return response.json();
      })
      .then(data => {
        alert(`Prix pr√©dit pour ce produit: ${data.predicted_price.toFixed(2)} ‚Ç¨`);
        // On ne ferme pas le modal ici pour permettre √† l'utilisateur d'ench√©rir
      })
      .catch(error => {
        console.error('Error:', error);
        alert("Une erreur est survenue lors de la pr√©diction du prix");
      });
    }

    function directBid() {
      if (!selectedProduct) return;
      // Fermer le modal de pr√©diction
      const modal = bootstrap.Modal.getInstance(document.getElementById('auctionModal'));
      if (modal) modal.hide();

      // Rediriger vers la page d'ench√®re sp√©cifique
      window.location.href = `/auction/${selectedProduct.id}`;
    }
  </script>
</body>
</html>